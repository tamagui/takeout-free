# uncloud deployment
# supports both self-hosted db (default) and external managed db
# use DB_EXTERNAL=true to skip pgdb service and use ZERO_UPSTREAM_DB from env

services:
  pgdb:
    image: pgvector/pgvector:pg16
    shm_size: 1g
    restart: always
    profiles:
      - self-hosted-db
    healthcheck:
      test: 'pg_isready -U ${POSTGRES_USER:-user} --dbname=${POSTGRES_DB:-postgres}'
      interval: 1s
      timeout: 5s
      retries: 10
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-user}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
    command: |
      postgres
      -c wal_level=logical
      -c max_wal_senders=10
      -c max_replication_slots=5
      -c hot_standby=on
      -c max_connections=256
    volumes:
      - pgdb_data:/var/lib/postgresql/data
      - ./src/database/:/docker-entrypoint-initdb.d

  migrate:
    image: takeout-web:latest
    restart: on-failure:3
    environment:
      - RUN=1
      - ALLOW_MISSING_ENV=1
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - ZERO_UPSTREAM_DB=${ZERO_UPSTREAM_DB:-postgresql://user:password@pgdb:5432/postgres}
      - ZERO_CVR_DB=${ZERO_CVR_DB:-postgresql://user:password@pgdb:5432/zero_cvr}
      - ZERO_CHANGE_DB=${ZERO_CHANGE_DB:-postgresql://user:password@pgdb:5432/zero_cdb}
      # ðŸ”’ start - this is generated by "bun env:update"
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - APNS_ENDPOINT=${APNS_ENDPOINT:-}
      - APNS_TEAM_ID=${APNS_TEAM_ID:-}
      - APNS_KEY_ID=${APNS_KEY_ID:-}
      - APNS_KEY=${APNS_KEY:-}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET:-}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL:-}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN:-}
      - CLOUDFLARE_R2_ACCESS_KEY=${CLOUDFLARE_R2_ACCESS_KEY:-}
      - CLOUDFLARE_R2_ENDPOINT=${CLOUDFLARE_R2_ENDPOINT:-}
      - CLOUDFLARE_R2_PUBLIC_URL=${CLOUDFLARE_R2_PUBLIC_URL:-}
      - CLOUDFLARE_R2_SECRET_KEY=${CLOUDFLARE_R2_SECRET_KEY:-}
      - DEPLOYMENT_PLATFORM=${DEPLOYMENT_PLATFORM:-}
      - DEPLOYMENT_ARCH=${DEPLOYMENT_ARCH:-}
      - DEPLOY_HOST=${DEPLOY_HOST:-}
      - DEPLOY_USER=${DEPLOY_USER:-}
      - DEPLOY_SSH_KEY=${DEPLOY_SSH_KEY:-}
      - DEPLOY_DB=${DEPLOY_DB:-}
      - ONE_SERVER_URL=${ONE_SERVER_URL:-}
      - POSTMARK_SERVER_TOKEN=${POSTMARK_SERVER_TOKEN:-}
      - VITE_DEMO_MODE=${VITE_DEMO_MODE:-}
      - VITE_POSTHOG_API_KEY=${VITE_POSTHOG_API_KEY:-}
      - VITE_POSTHOG_HOST=${VITE_POSTHOG_HOST:-}
      - VITE_PUBLIC_ZERO_SERVER=${VITE_PUBLIC_ZERO_SERVER:-}
      - WEB_DOMAIN=${WEB_DOMAIN:-}
      - ZERO_DOMAIN=${ZERO_DOMAIN:-}
      - ZERO_VERSION=${ZERO_VERSION:-}
      # ðŸ”’ end - this is generated by "bun env:update"
    command: ["node", "/app/src/database/migrate-dist.js"]

  zero:
    image: "rocicorp/zero:${ZERO_VERSION:-latest}"
    restart: always
    depends_on:
      - migrate
    x-ports:
      - ${ZERO_DOMAIN:-zero-takeout.uncld.dev}:4859/https
    environment:
      - ZERO_ADMIN_PASSWORD=${ZERO_ADMIN_PASSWORD:-production-admin-change-me}
      - ZERO_LOG_LEVEL=${ZERO_LOG_LEVEL:-info}
      - ZERO_MUTATE_URL=http://web:8092/api/zero/push
      - ZERO_QUERY_URL=http://web:8092/api/zero/pull
      - ZERO_MUTATE_FORWARD_COOKIES=true
      - ZERO_QUERY_FORWARD_COOKIES=true
      - ZERO_UPSTREAM_DB=${ZERO_UPSTREAM_DB:-postgresql://user:password@pgdb:5432/postgres}
      - ZERO_CVR_DB=${ZERO_CVR_DB:-postgresql://user:password@pgdb:5432/zero_cvr}
      - ZERO_CHANGE_DB=${ZERO_CHANGE_DB:-postgresql://user:password@pgdb:5432/zero_cdb}
      - ZERO_REPLICA_FILE=/app/sync-replica.db
      - ZERO_NUM_SYNC_WORKERS=${ZERO_NUM_SYNC_WORKERS:-2}
      - ZERO_CVR_MAX_CONNS=${ZERO_CVR_MAX_CONNS:-4}
      - ZERO_UPSTREAM_MAX_CONNS=${ZERO_UPSTREAM_MAX_CONNS:-8}
    volumes:
      - zero_data:/app
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4859/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  minio:
    image: minio/minio
    restart: always
    entrypoint: sh
    command: -c 'mkdir -p /data/chat && minio server --address ":9000" --console-address ":9001" /data'
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio_password
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 1s
      timeout: 5s
      retries: 5
      start_period: 1s

  minio-init:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
        until mc alias set local http://minio:9000 minio minio_password; do
          echo 'Waiting for MinIO...';
          sleep 1;
        done &&
        mc mb --ignore-existing local/chat &&
        mc anonymous set download local/chat &&
        echo 'âœ… MinIO chat bucket ready and public';
      "

  web:
    image: takeout-web:latest
    restart: always
    depends_on:
      - zero
    x-ports:
      - ${WEB_DOMAIN:-takeout.uncld.dev}:8092/https
    environment:
      - NODE_ENV=production
      - ZERO_MUTATE_URL=http://web:8092/api/zero/push
      - ZERO_QUERY_URL=http://web:8092/api/zero/pull
      - ZERO_UPSTREAM_DB=${ZERO_UPSTREAM_DB:-postgresql://user:password@pgdb:5432/postgres}
      - ZERO_CVR_DB=${ZERO_CVR_DB:-postgresql://user:password@pgdb:5432/zero_cvr}
      - ZERO_CHANGE_DB=${ZERO_CHANGE_DB:-postgresql://user:password@pgdb:5432/zero_cdb}
      # ðŸ”’ start - this is generated by "bun env:update"
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - APNS_ENDPOINT=${APNS_ENDPOINT:-}
      - APNS_TEAM_ID=${APNS_TEAM_ID:-}
      - APNS_KEY_ID=${APNS_KEY_ID:-}
      - APNS_KEY=${APNS_KEY:-}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET:-}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL:-}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN:-}
      - CLOUDFLARE_R2_ACCESS_KEY=${CLOUDFLARE_R2_ACCESS_KEY:-}
      - CLOUDFLARE_R2_ENDPOINT=${CLOUDFLARE_R2_ENDPOINT:-}
      - CLOUDFLARE_R2_PUBLIC_URL=${CLOUDFLARE_R2_PUBLIC_URL:-}
      - CLOUDFLARE_R2_SECRET_KEY=${CLOUDFLARE_R2_SECRET_KEY:-}
      - DEPLOYMENT_PLATFORM=${DEPLOYMENT_PLATFORM:-}
      - DEPLOYMENT_ARCH=${DEPLOYMENT_ARCH:-}
      - DEPLOY_HOST=${DEPLOY_HOST:-}
      - DEPLOY_USER=${DEPLOY_USER:-}
      - DEPLOY_SSH_KEY=${DEPLOY_SSH_KEY:-}
      - DEPLOY_DB=${DEPLOY_DB:-}
      - ONE_SERVER_URL=${ONE_SERVER_URL:-}
      - POSTMARK_SERVER_TOKEN=${POSTMARK_SERVER_TOKEN:-}
      - VITE_DEMO_MODE=${VITE_DEMO_MODE:-}
      - VITE_POSTHOG_API_KEY=${VITE_POSTHOG_API_KEY:-}
      - VITE_POSTHOG_HOST=${VITE_POSTHOG_HOST:-}
      - VITE_PUBLIC_ZERO_SERVER=${VITE_PUBLIC_ZERO_SERVER:-}
      - WEB_DOMAIN=${WEB_DOMAIN:-}
      - ZERO_DOMAIN=${ZERO_DOMAIN:-}
      - ZERO_VERSION=${ZERO_VERSION:-}
      # ðŸ”’ end - this is generated by "bun env:update"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8092/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  pgdb_data:
  zero_data:
  minio_data:

networks:
  default:
    enable_ipv6: true
    ipam:
      config:
        - subnet: fd00::/80
